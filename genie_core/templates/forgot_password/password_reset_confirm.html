{% extends "login.html" %}
{% load static i18n %}

{% block login %}
{% if validlink %}
            <!-- RESET PASSWORD FORM -->
            <div id="sec1" class="bg-white p-[50px] rounded-md shadow w-[450px]">
                <div id="messages-container" style="display:none;">
                    {% for message in messages %}
                        <div class="message" data-level="{{ message.tags }}" data-message="{{ message }}"></div>
                    {% endfor %}
                </div>
                <h1 class="text-3xl font-bold mb-2 text-center">{% trans "Reset Your Password" %}</h1>
                <p class="mb-5 text-center text-sm text-color-600">
                    {% trans "Please enter your new password" %}
                </p>

                <form method="post"
                hx-post="{% url 'horilla_core:password_reset_confirm' uidb64=uidb64 token=token %}"
                hx-target="#sec1"
                hx-select="#sec1"
                hx-swap="outerHTML"
                hx-push-url="true">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="new_password" class="text-sm text-color-600">{% trans "New Password" %}</label>
                        <div class="relative">
                            <input
                                id="new_password"
                                type="password"
                                name="new_password"
                                autocomplete="off"
                                placeholder="Enter new password"
                                value="{{ new_password|default:'' }}"
                                required
                                class="text-color-600 p-3 pr-[40px] w-full border border-dark-50 rounded-md mt-1 placeholder:text-dark-100 text-sm focus:border-primary-600 focus-visible:outline-0"
                            />
                            <button
                                type="button"
                                class="password-toggle absolute right-3 top-0 bottom-0 m-auto cursor-pointer"
                                data-input="new_password"
                                data-eye="eyeIcon1"
                                data-eye-hide="eyeHideIcon1">
                                <img id="eyeIcon1" src="{% static 'assets/icons/eye.svg' %}" alt="Toggle visibility" class='hidden' />
                                <img id="eyeHideIcon1" src="{% static 'assets/icons/eye-hide.svg' %}" width="21" alt="Toggle visibility" />
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="confirm_password" class="text-sm text-color-600">{% trans "Confirm Password" %}</label>
                        <div class="relative">
                            <input
                                id="confirm_password"
                                type="password"
                                name="confirm_password"
                                autocomplete="off"
                                value="{{ confirm_password|default:'' }}"
                                placeholder="Confirm new password"
                                required
                                class="text-color-600 p-3 pr-[40px] w-full border border-dark-50 rounded-md mt-1 placeholder:text-dark-100 text-sm focus:border-primary-600 focus-visible:outline-0"
                            />
                            <button
                                type="button"
                                class="password-toggle absolute right-3 top-0 bottom-0 m-auto cursor-pointer"
                                data-input="confirm_password"
                                data-eye="eyeIcon2"
                                data-eye-hide="eyeHideIcon2">
                                <img id="eyeIcon2" src="{% static 'assets/icons/eye.svg' %}" alt="Toggle visibility" class='hidden' />
                                <img id="eyeHideIcon2" src="{% static 'assets/icons/eye-hide.svg' %}" width="21" alt="Toggle visibility" />
                            </button>
                        </div>
                    </div>

                    <button
                        type="submit"
                        class="p-3 bg-primary-600 hover:bg-secondary-600 w-full flex gap-3 justify-center rounded-md text-white transition duration-300 mt-5">
                        <img src="{% static 'assets/icons/sign.svg' %}" alt="" />
                        {% trans "Reset Password" %}
                    </button>
                </form>

                <div class="text-center mt-4">
                    <a hx-get="{% url 'horilla_core:login' %}"
                    hx-target="#sec1"
                    hx-select="#sec1"
                    hx-swap="outerHTML"
                    hx-push-url="true"
                    class="text-sm text-primary-600 hover:underline">
                        {% trans "Back to login" %}
                    </a>
                </div>

                <script>
                    // Use event delegation - attach to document so it works after HTMX swaps
                    document.addEventListener('click', function(e) {
                        if (e.target.closest('.password-toggle')) {
                            const button = e.target.closest('.password-toggle');
                            const inputId = button.getAttribute('data-input');
                            const eyeId = button.getAttribute('data-eye');
                            const eyeHideId = button.getAttribute('data-eye-hide');

                            const passwordInput = document.getElementById(inputId);
                            const eyeIcon = document.getElementById(eyeId);
                            const eyeHideIcon = document.getElementById(eyeHideId);

                            if (passwordInput && eyeIcon && eyeHideIcon) {
                                if (passwordInput.type === 'password') {
                                    passwordInput.type = 'text';
                                    eyeIcon.classList.remove('hidden');
                                    eyeHideIcon.classList.add('hidden');
                                } else {
                                    passwordInput.type = 'password';
                                    eyeIcon.classList.add('hidden');
                                    eyeHideIcon.classList.remove('hidden');
                                }
                            }
                        }
                    });

                    $(document).ready(function() {
                        showMessages();
                    });
                </script>
            </div>

            {% else %}

            <div id="sec1" class="bg-white p-[50px] rounded-md shadow w-[450px]">
                <h1 class="text-2xl font-bold mb-2 text-center text-primary-600">{% trans "Invalid Link" %}</h1>
                <p class="mb-5 text-center text-sm text-color-600">
                    {% trans "This password reset link is invalid or has expired." %}
                </p>
                <p class="mb-5 text-center text-sm text-color-600">
                    {% trans "Please request a new password reset link." %}
                </p>

                <button
                    hx-get="{% url 'horilla_core:login' %}"
                    hx-target="#sec1"
                    hx-select="#sec1"
                    hx-swap="outerHTML"
                    hx-push-url="true"
                    class="p-3 bg-primary-600 hover:bg-secondary-600 w-full flex gap-3 justify-center rounded-md text-white transition duration-300 text-center">
                    <img src="{% static 'assets/icons/sign.svg' %}" alt="" />
                    {% trans "Back to Login" %}
            </button>
            </div>
            {% endif %}
        </div>

        <script src="{% url 'javascript-catalog' %}"></script>
   {% endblock login %}
