{% extends "login.html" %}
{% load static i18n %}
{% block login %}

<div id="load-sec" class="bg-white p-[20px] rounded-md shadow w-[900px]">
  <div class="p-5">
    <h2 class="text-lg font-semibold mb-2">{% trans "Loading Demo Database" %}</h2>
    <p class="mb-5 text-sm text-color-600">
      {% trans "Please wait while we load the demo data..." %}
    </p>

    <div class="space-y-4">
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div
          id="progress-bar"
          class="h-2 rounded-full transition-all duration-300"
          style="width: 0%"
        ></div>
      </div>

      <div class="flex justify-between items-center text-sm text-color-600">
        <span id="progress-text">{% trans "Initializing..." %}</span>
        <span id="progress-percent">0%</span>
      </div>

      <div class="mt-6 max-h-[300px] overflow-y-auto bg-gray-50 rounded-md p-4">
        <div id="file-list" class="space-y-2">
          {% for file in data_files %}
          <div class="file-item flex items-center gap-3 text-sm text-color-600" data-file="{{ file }}">
            <span class="file-status">
              <svg class="pending w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke-width="2"/>
              </svg>
              <svg class="done hidden w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
              </svg>
              <svg class="error hidden w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
              </svg>
            </span>
            <span class="file-name">{{ file }}</span>
          </div>
          {% endfor %}
        </div>
      </div>

      <div id="status-message" class="text-sm text-color-600"></div>

      <div id="success-message" class="hidden text-sm p-3 rounded bg-green-50">
        <span class="text-green-700">
          {% trans "Success! Demo database loaded. You can now login with username 'admin' and password 'admin'." %}
        </span>
      </div>
      <div id="loading-animation" class="hidden mt-6">
        <div class="flex justify-center items-center p-4">
          <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-[#e54f38]"></div>
        </div>
      </div>

    </div>
  </div>
</div>


<script>
  (function() {
    let currentFileIndex = 0;
    const totalFiles = {{ total_files }};
    let currentProgress = 0;
    let targetProgress = 0;
    let isLoading = false;
    let animationFrameId = null;

    function animateProgress() {
      const progressBar = document.getElementById('progress-bar');
      const progressPercent = document.getElementById('progress-percent');

      if (isLoading && currentProgress < targetProgress - 2) {
        currentProgress += 0.15;
      } else if (currentProgress < targetProgress) {
        currentProgress += 1.0;

        if (currentProgress > targetProgress) {
          currentProgress = targetProgress;
        }
      }

      if (progressBar) {
        progressBar.style.width = currentProgress + '%';

        progressBar.classList.remove('bg-red-500', 'bg-orange-500', 'bg-green-500');
        if (currentProgress < 40) {
          progressBar.classList.add('bg-red-500');
        } else if (currentProgress < 80) {
          progressBar.classList.add('bg-orange-500');
        } else {
          progressBar.classList.add('bg-green-500');
        }
      }

      if (progressPercent) {
        progressPercent.textContent = Math.round(currentProgress) + '%';
      }

      animationFrameId = requestAnimationFrame(animateProgress);
    }

    function updateProgress(data) {
      const progressText = document.getElementById('progress-text');

      if (data.progress !== undefined) {
        targetProgress = data.progress;
        isLoading = false;

        if (!animationFrameId) {
          animateProgress();
        }
      }

      if (progressText) {
        const displayName = data.display_name || data.file;
        progressText.textContent = '{% trans "Loading" %} ' + '... (' + data.current + '/' + data.total + ')';
      }

      //if (progressText && data.file) {
      //  progressText.textContent = '{% trans "Loading" %} ' + data.file + '... (' + data.current + '/' + data.total + ')';
      //}

      if (data.file) {
        const fileItems = document.querySelectorAll('.file-item');
        fileItems.forEach(item => {
          if (item.dataset.file === data.file) {
            const pending = item.querySelector('.pending');
            const done = item.querySelector('.done');
            if (pending) pending.classList.add('hidden');
            if (done) done.classList.remove('hidden');
          }
        });
      }
    }

    function showError(message, filename) {
      const statusMessage = document.getElementById('status-message');
      if (statusMessage) {
        statusMessage.innerHTML = '<span class="text-red-500">{% trans "Error:" %} ' + message + '</span>';
      }

      if (filename) {
        const fileItems = document.querySelectorAll('.file-item');
        fileItems.forEach(item => {
          if (item.dataset.file === filename) {
            const pending = item.querySelector('.pending');
            const error = item.querySelector('.error');
            if (pending) pending.classList.add('hidden');
            if (error) error.classList.remove('hidden');
          }
        });
      }

      // Stop animation on error
      isLoading = false;
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
    }

    function showSuccess() {
      const successMessage = document.getElementById('success-message');
      const loadingAnimation = document.getElementById('loading-animation');

      isLoading = false;
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }

      if (successMessage) {
        successMessage.classList.remove('hidden');
      }
      if (loadingAnimation) loadingAnimation.classList.remove('hidden');

      setTimeout(() => {
        window.location.href = '{% url "horilla_core:login" %}';
      }, 6000);
    }

    function loadNextFile() {
      if (currentFileIndex >= totalFiles) {
        showSuccess();
        return;
      }

      // Calculate the target progress for this file
      const nextTargetProgress = ((currentFileIndex + 1) / totalFiles) * 100;

      // Set simulated target (leave 2% buffer for server response)
      targetProgress = nextTargetProgress - 2;
      isLoading = true;

      // Start animation if not already running
      if (!animationFrameId) {
        animateProgress();
      }

      const url = '{% url "horilla_core:load_demo_data" %}?file_index=' + currentFileIndex;

      fetch(url, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          updateProgress(data);
          currentFileIndex++;

          // Load next file immediately
          setTimeout(() => loadNextFile(), 100);

        } else if (data.status === 'complete') {
          showSuccess();

        } else if (data.status === 'error') {
          showError(data.message, data.file);
        }
      })
      .catch(error => {
        showError('{% trans "Network error occurred" %}');
      });
    }

    loadNextFile();
  })();
  </script>

{% endblock login %}
