{% load i18n %}

<div>
    <label class="text-xs text-color-600 mb-1">{% trans "Upload File" %}</label>

    <div class="relative">
        <label for="{{ widget.attrs.id }}"
            class="bg-white flex flex-col items-center justify-center w-full h-[6rem] border-2 border-dashed border-[#d5d5d5] rounded-lg cursor-pointer hover:border-gray-400 transition relative">

            <div id="uploadBoxContent_{{ widget.attrs.id }}" class="flex flex-col items-center justify-center text-center px-2">
                {% if selected_filename %}
                    <i class="fa-solid fa-file text-xl mb-2 text-green-500"></i>
                    <p class="text-sm font-semibold text-gray-700 truncate max-w-full">{{ selected_filename }}</p>
                    <p class="text-xs text-[#9e9e9e]">{% trans "File already uploaded" %}</p>
                {% else %}
                    <i class="fa-solid fa-arrow-up-from-bracket text-xl mb-2 text-gray-500"></i>
                    <p class="text-sm font-semibold text-gray-700">{% trans "Click to upload" %}</p>
                    <p class="text-xs text-[#9e9e9e]">{% trans "Any file (Max 10MB)" %}</p>
                {% endif %}
            </div>

            <input type="{{ widget.type }}"
                   name="{{ widget.name }}"
                   class="hidden file-upload-input"
                   data-upload-box="uploadBoxContent_{{ widget.attrs.id }}"
                   {% if widget.required and not selected_filename %}required{% endif %}
                   {% include "django/forms/widgets/attrs.html" %} />
        </label>

        <!-- Clear button -->
        <button type="button"
                id="clearButton_{{ widget.attrs.id }}"
                class="absolute top-2 right-2 text-xs text-red-600 hover:text-red-800 hover:underline z-10 {% if not selected_filename %}hidden{% endif %}">
            {% trans "Clear" %}
        </button>
    </div>

    <!-- Hidden checkbox for clearing existing files (controlled by clear button) -->
    {% if selected_filename %}
    <input type="checkbox" name="{{ widget.checkbox_name }}" id="{{ widget.checkbox_id }}" class="hidden">
    {% endif %}
</div>

<script>
(function() {
    function initFileUpload() {
        const fileInput = document.getElementById("{{ widget.attrs.id }}");
        const uploadBoxContent = document.getElementById("uploadBoxContent_{{ widget.attrs.id }}");
        const clearButton = document.getElementById("clearButton_{{ widget.attrs.id }}");

        if (fileInput && uploadBoxContent) {
            // Remove any existing listeners to prevent duplicates
            const newFileInput = fileInput.cloneNode(true);
            fileInput.parentNode.replaceChild(newFileInput, fileInput);

            newFileInput.addEventListener("change", function () {
                const file = this.files[0];
                if (file) {
                    uploadBoxContent.innerHTML = `
                        <i class="fa-solid fa-file text-xl mb-2 text-green-500"></i>
                        <p class="text-sm font-semibold text-gray-700 truncate max-w-full">${file.name}</p>
                        <p class="text-xs text-[#9e9e9e]">{% trans "File selected" %}</p>
                    `;
                    if (clearButton) {
                        clearButton.classList.remove('hidden');
                    }
                } else {
                    uploadBoxContent.innerHTML = `
                        <i class="fa-solid fa-arrow-up-from-bracket text-xl mb-2 text-gray-500"></i>
                        <p class="text-sm font-semibold text-gray-700">{% trans "Click to upload" %}</p>
                        <p class="text-xs text-[#9e9e9e]">{% trans "Any file (Max 10MB)" %}</p>
                    `;
                    if (clearButton) {
                        clearButton.classList.add('hidden');
                    }
                }
            });

            // Clear button functionality
            if (clearButton) {
                clearButton.addEventListener("click", function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Clear the file input
                    newFileInput.value = '';

                    // Check the hidden checkbox to mark file for deletion
                    const clearCheckbox = document.getElementById("{{ widget.checkbox_id }}");
                    if (clearCheckbox) {
                        clearCheckbox.checked = true;
                    }

                    // Reset the upload box content
                    uploadBoxContent.innerHTML = `
                        <i class="fa-solid fa-arrow-up-from-bracket text-xl mb-2 text-gray-500"></i>
                        <p class="text-sm font-semibold text-gray-700">{% trans "Click to upload" %}</p>
                        <p class="text-xs text-[#9e9e9e]">{% trans "Any file (Max 10MB)" %}</p>
                    `;

                    // Hide clear button
                    clearButton.classList.add('hidden');
                });
            }
        }
    }

    // Initialize on DOM load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFileUpload);
    } else {
        initFileUpload();
    }

    // Re-initialize after HTMX swaps content
    document.body.addEventListener('htmx:afterSwap', function(event) {
        // Small delay to ensure DOM is updated
        setTimeout(initFileUpload, 10);
    });
})();
</script>
